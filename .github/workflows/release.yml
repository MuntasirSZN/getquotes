name: 🚀 Release Builds and Publish
on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
jobs:
  test:
    uses: ./.github/workflows/test-code.yaml
    name: 🧪 Test Code
    # ======================== Platform-Specific Build Jobs ======================== #
  build-linux:
    uses: ./.github/workflows/build-linux.yaml
    name: 🏗️ Build For Linux
    needs: test
  build-android:
    uses: ./.github/workflows/build-android.yaml
    name: 🏗️ Build For Android
    needs: test
  build-macos:
    uses: ./.github/workflows/build-mac.yaml
    name: 🏗️ Build For MacOS
    needs: test
  build-windows:
    uses: ./.github/workflows/build-windows.yaml
    name: 🏗️ Build For Windows
    needs: test
  # ================================ Release Job ================================ #
  release-github:
    uses: ./.github/workflows/release-github.yaml
    name: 🚀 Create Github Release
    needs: [build-linux, build-android, build-macos, build-windows]
  release-cargo:
    name: 🚀 Create Cargo Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-android, build-macos, build-windows]
    steps:
      - name: 🔍 Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: 📦 Publish to crates.io
        run: cargo publish --token ${{ secrets.CRATES_IO_TOKEN }} --allow-dirty
  release-aur:
    name: 🚀 Create AUR Release
    runs-on: ubuntu-latest
    needs: [release-github,release-cargo]
    steps:
      - name: 🔍 Checkout Code
        uses: actions/checkout@v4
        with:
          ref: "main"
          fetch-depth: 0
      - name: 🔒 Update PKGBUILD pkgver
        run: |
          cd ci
          ./pkgbuild-ci.sh
          cd ..
      - name: 💠 Publish To Aur
        uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
        with:
          pkgname: getquotes
          pkgbuild: ./packages/aur/getquotes/PKGBUILD
          updpkgsums: true
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: Update AUR package
          ssh_keyscan_types: rsa,ecdsa,ed25519
      - name: 💫 Commit PKGBUILD
        uses: EndBug/add-and-commit@v9
        with:
          add: "packages/aur/getquotes/PKGBUILD"
          message: "📝 Update PKGBUILD"
  changelog:
    name: 📝 Update Changelog
    runs-on: ubuntu-latest
    needs: [release-github,release-aur,release-cargo]
    steps:
      - name: 🔍 Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: 💱 Generate Changelog
        run: |
          docker pull quay.io/git-chglog/git-chglog:latest
          docker run -v "$PWD":/workdir quay.io/git-chglog/git-chglog -o CHANGELOG.md
      - name: 💫 Commit Changelog And PKGBUILD
        uses: EndBug/add-and-commit@v9
        with:
          add: "CHANGELOG.md"
          message: "📝 Update CHANGELOG.md"
